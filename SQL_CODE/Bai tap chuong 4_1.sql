-- TẠO DATABASE 

CREATE DATABASE QLSV_C4_1
ON(
NAME = 'QLSV_C4.1',
FILENAME = 'F:\CSDL\SQL_DATA\QLSV_C4.mdf',
SIZE = 10 MB,
MAXSIZE = UNLIMITED,
FILEGROWTH = 5 MB)
LOG ON(
NAME = 'QLSV_C4_LOG',
FILENAME = 'F:\CSDL\SQL_DATA\QLSV_C4.1_LOG.ldf',
SIZE = 5 MB,
MAXSIZE = UNLIMITED,
FILEGROWTH = 2 MB)
GO

-- CREATE TABLE

USE QLSV_C4_1

/*BẢNG SINHVIEN
MASV - diễn giải - char - 12 -  - PK
TEN  - diễn giải - nvarchar - 100 - not null
NAM  - diễn giải - int -   -   - {1,2,3,4}
MAKHOA-diễn giải - varchar - 6 - MKxxxx - not null,FK*/

CREATE TABLE SINHVIEN
(
MASV CHAR(8) CONSTRAINT PK_SV PRIMARY KEY,
TEN NVARCHAR(100) NOT NULL,
NAM INT DEFAULT 1 CONSTRAINT NAM_CHK CHECK(NAM>=1 OR NAM<=6) NULL,
MAKHOA VARCHAR(10) NOT NULL,
CONSTRAINT FK_SV_KHOA FOREIGN KEY (MAKHOA) REFERENCES dbo.KHOA(MAKHOA)
)
GO 

/*BẢNG KHOA
MAKHOA - diễn giải - varchar - 6 - MKxxxx - not null,PK
TENKHOA- diễn giải - nvarchar- 100-not null
NAMTL  - diễn giải - int*/

CREATE TABLE KHOA
(
MAKHOA VARCHAR(10) NOT NULL CONSTRAINT PK_K PRIMARY KEY,
TENKHOA NVARCHAR(50) NOT NULL UNIQUE,
NAMTL INT NULL
)
GO


/*BẢNG MONHOC
MAMH - diễn giải - varchar - 10 - PK,not null,unique
MONHOC diễn giải - nvarchar- 100- not null
TINCHI diễn giải - int     - not null
MAKHOA diễn giải - varchar -6   - FK,not null*/

CREATE TABLE MONHOC
(
MAMH CHAR(6) CONSTRAINT PK_MH PRIMARY KEY,
TENMH NVARCHAR(100) UNIQUE NOT NULL,
TINCHI INT DEFAULT 3 CONSTRAINT CHK_TINCHI CHECK (TINCHI>=3 AND TINCHI<=6) NULL,
MAKHOA VARCHAR(10) NOT NULL,
CONSTRAINT FK_MAMH_MAKHOA FOREIGN KEY (MAKHOA) REFERENCES dbo.KHOA(MAKHOA)
)
GO

/*BẢNG HOCPHAN
MAHP - diễn giải - varchar - 100 - PK
HOCKY- diễn giải - int           - not null
NAMHOC diễn giải - int           - not null
GIAOVIEN         - nvarchar - 100 not null
MAMH - diễn giải - varchar - 10 - FK*/

CREATE TABLE HOCPHAN
(
MAHP INT CONSTRAINT PK_HP PRIMARY KEY,
HOCKY INT CONSTRAINT CHK_HOCKY CHECK(HOCKY IN (1,2,3)) NULL,
NAMHOC INT NULL CONSTRAINT CHK_NAMHOC CHECK (YEAR(GETDATE())>=NAMHOC),
GIAOVIEN NVARCHAR(50) NULL,
MAMH CHAR(6) NOT NULL CONSTRAINT FK_HP_MAMH FOREIGN KEY (MAMH) REFERENCES dbo.MONHOC(MAMH)
)
go

/*BẢNG KETQUA
MASV - char - 12 - PK,FK
MAMH - varchar10 - PK,FK
DIEM - int*/

CREATE TABLE KETQUA
(
MASV CHAR(8) NOT NULL,
MAHP INT NOT NULL,
DIEM FLOAT DEFAULT 0 NULL,
CONSTRAINT DIEM_CHK CHECK (DIEM>=0 AND DIEM<=10),
CONSTRAINT PK_KQ PRIMARY KEY(MASV,MAHP),
CONSTRAINT FK_MASV FOREIGN KEY (MASV) REFERENCES dbo.SINHVIEN(MASV),
CONSTRAINT FK_MAHP FOREIGN KEY (MAHP) REFERENCES dbo.HOCPHAN(MAHP),
)
GO

/*BẢNG DIEUKIEN
MAHP - varchar - 10 - PK,FK
MAHPTRUOC - varchar - 10 - PK,FK*/

CREATE TABLE DIEUKIEN
(MAMH CHAR(6) NOT NULL,
MAMH_TRUOC CHAR(6) NOT NULL,
CONSTRAINT PK_DK PRIMARY KEY(MAMH,MAMH_TRUOC),
CONSTRAINT FK_MH FOREIGN KEY (MAMH) REFERENCES dbo.MONHOC(MAMH),
CONSTRAINT FK_MH_TRUOC FOREIGN KEY (MAMH_TRUOC) REFERENCES dbo.MONHOC(MAMH)
)
GO

INSERT INTO KHOA VALUES
('TOAN',N'Toán',1976),
('HOA',N'Hóa',1980),
('SINH',N'Sinh',1981),
('VLY',N'Vật lý',1982)
GO

INSERT INTO SINHVIEN VALUES
('K27.0017',N'Nguyễn Công Phú',1,'TOAN'),
('K26.0008',N'Phan Anh Khanh',2,'TOAN'),
('K25.0005',N'Lý Thành',3,'HOA'),
('K27.0018',N'Hàn Quốc Việt',2,'VLY')
GO

INSERT INTO MONHOC VALUES
('TH0001',N'Tin học đại cương',4,'TOAN'),
('TH0002',N'Cấu trúc dữ liệu',4,'TOAN'),
('TO0001',N'Toán rời rạc',3,'TOAN'),
('HH0001',N'Hóa học đại cương A1',5,'HOA'),
('HH0002',N'Hóa học đại cương A2',5,'HOA'),
('VL0002',N'Vật lý đại cương A2',4,'VLY'),
('TH0003',N'Cơ sở dữ liệu',5,'TOAN'),
('VL0001',N'Vật lý đại cương A1',5,'VLY')
GO

INSERT INTO HOCPHAN(MAHP,MAMH,HOCKY,NAMHOC,GIAOVIEN) VALUES
(1,'TH0001',1,1996,N'N.D.Lâm'),
(2,'VL0001',1,1996,N'T.N.Dung'),
(3,'TH0002',1,1997,N'H.Tuân'),
(4,'TH0001',1,1997,N'N.D.Lâm'),
(5,'TH0003',2,1997,N'N.C.Phú'),
(6,'HH0001',1,1996,N'L.T.Phúc'),
(7,'TH0002',1,1998,N'P.T.Như'),
(8,'TO0001',1,1996,N'N.C.Phú')
GO

INSERT INTO KETQUA VALUES
('K27.0017',4,9.5),
('K26.0008',1,10),
('K25.0005',6,6),
('K27.0018',2,8),
('K26.0008',3,9)
GO

INSERT INTO DIEUKIEN VALUES
('TO0001','TH0003'),
('TH0003','TH0002'),
('TH0002','TH0001'),
('HH0002','HH0001'),
('VL0002','VL0001')
GO


--CÂU 1
SELECT MASV, TEN
FROM SINHVIEN SV JOIN KHOA K ON SV.MAKHOA=K.MAKHOA
WHERE TENKHOA=N'TOÁN'
GO
 
 --CÂU 2
 SELECT TENMH, TINCHI
 FROM MONHOC
 GO

 --CÂU 3
 SELECT SV.MASV, TEN, HP.MAHP, TENMH, DIEM
 FROM SINHVIEN SV, HOCPHAN HP, MONHOC MH, KETQUA KQ
 WHERE SV.MASV=KQ.MASV AND HP.MAHP=KQ.MAHP AND HP.MAMH=MH.MAMH AND SV.MASV='K26.0008'
 GO

 --CÂU 4
 SELECT TEN, MH.MAMH, DIEM
 FROM SINHVIEN SV, MONHOC MH, KETQUA KQ, HOCPHAN HP
 WHERE SV.MASV=KQ.MASV AND HP.MAHP=KQ.MAHP AND HP.MAMH=MH.MAMH AND DIEM>7
GO

 --CÂU 5
 SELECT TEN
 FROM SINHVIEN SV, KHOA K, MONHOC MH
 WHERE SV.MAKHOA=K.MAKHOA AND K.MAKHOA=MH.MAKHOA AND TENMH=N'TOÁN RỜI RẠC'
 GO

 --CÂU 6
 SELECT TEN, TENMH,DIEM, HOCKY,HP.NAMHOC
 FROM SINHVIEN SV, KETQUA KQ, HOCPHAN HP, MONHOC MH
 WHERE SV.MASV=KQ.MASV AND KQ.MAHP=HP.MAHP AND MH.MAMH=HP.MAMH AND HOCKY=1 AND NAMHOC=1996
 GO

 --CÂU 7
 SELECT MH1.MAMH, MH1.TENMH 
 FROM MONHOC MH, DIEUKIEN DK, MONHOC MH1
 WHERE MH.TENMH=N'CƠ SỞ DỮ LIỆU' AND MH.MAMH=DK.MAMH AND DK.MAMH_TRUOC=MH1.MAMH
 GO

 --CÂU 8
SELECT MH1.MAMH, MH1.TENMH 
 FROM MONHOC MH, DIEUKIEN DK, MONHOC MH1
 WHERE MH.TENMH=N'CƠ SỞ DỮ LIỆU' AND MH.MAMH=DK.MAMH_TRUOC AND DK.MAMH=MH1.MAMH
 GO

 --CÂU 9
 SELECT MH.TENMH N'Tên môn học', MH1.TENMH N'Tên môn học trước', MH.TINCHI N'Tín chỉ'
 FROM MONHOC MH, DIEUKIEN DK, MONHOC MH1
 WHERE MH.MAMH=DK.MAMH AND DK.MAMH_TRUOC=MH1.MAMH AND MH.TINCHI<=4
 GO

 --CÂU 10
 SELECT SV.MASV, TEN, DIEM, TENMH
 FROM SINHVIEN SV, KETQUA KQ, HOCPHAN HP, MONHOC MH
 WHERE SV.MASV=KQ.MASV AND HP.MAHP=KQ.MAHP AND HP.MAMH=MH.MAMH AND TENMH=N'CƠ SỞ DỮ LIỆU' AND HOCKY=1 AND NAMHOC=1996
 ORDER BY DIEM DESC, TEN ASC
 GO

 --CÂU 11
SELECT HP.MAHP,COUNT(KQ.MASV) N'Số lượng sinh viên'
FROM (HOCPHAN HP JOIN KETQUA KQ ON HP.MAHP=KQ.MAHP)
GROUP BY HP.MAHP
GO

--CÂU 12
SELECT SV.MASV, TEN,NAMHOC, AVG(DIEM) N'Điểm trung bình'
FROM SINHVIEN SV, KETQUA KQ, HOCPHAN HP
WHERE SV.MASV=KQ.MASV AND HP.MAHP=KQ.MAHP
GROUP BY SV.MASV, TEN,NAMHOC

--CÂU 13
SELECT SV.MASV, TEN, DIEM
FROM SINHVIEN SV, KETQUA KQ
WHERE SV.MASV=KQ.MASV AND DIEM>=ALL
								(SELECT DIEM
								FROM KETQUA KQ)
GO

--CÂU 14
SELECT SV.MASV, TEN, DIEM
FROM SINHVIEN SV, KETQUA KQ, HOCPHAN HP, MONHOC MH
WHERE SV.MASV=KQ.MASV AND HP.MAHP=KQ.MAHP AND MH.MAMH=HP.MAMH
AND TENMH=N'CƠ SỞ DỮ LIỆU' AND HOCKY=1 AND NAMHOC=1996 
AND DIEM>=ALL
		(SELECT DIEM
		FROM KETQUA KQ, HOCPHAN HP, MONHOC MH
		WHERE HP.MAHP=KQ.MAHP AND MH.MAMH=HP.MAMH
		AND TENMH=N'CƠ SỞ DỮ LIỆU' AND HOCKY=1 AND NAMHOC=1996)
GO

--CÂU 15
SELECT SV.MASV, TEN, AVG(DIEM) N'Điểm trung bình'
FROM SINHVIEN SV, KETQUA KQ, HOCPHAN HP
WHERE SV.MASV=KQ.MASV AND HP.MAHP=KQ.MAHP
AND HOCKY=1 AND NAMHOC=1996
GROUP BY SV.MASV, TEN
HAVING AVG(DIEM)>=ALL
		(SELECT AVG(DIEM)
		FROM KETQUA KQ, HOCPHAN HP
		WHERE HP.MAHP=KQ.MAHP
		AND HOCKY=1 AND NAMHOC=1996
		GROUP BY KQ.MASV)
GO

--CÂU 16
SELECT TOP 10 SV.MASV, TEN, DIEM
FROM SINHVIEN SV, KETQUA KQ, HOCPHAN HP, MONHOC MH
WHERE SV.MASV=KQ.MASV AND HP.MAHP=KQ.MAHP AND MH.MAMH=HP.MAMH
AND HOCKY=1 AND NAMHOC=1996 AND TENMH=N'CƠ SỞ DỮ LIỆU'
ORDER BY DIEM DESC
GO

--CÂU 17
SELECT TEN
FROM SINHVIEN
EXCEPT
SELECT TEN
FROM SINHVIEN SV, KETQUA KQ, MONHOC MH, HOCPHAN HP
WHERE SV.MASV=KQ.MASV AND KQ.MAHP=HP.MAHP AND HP.MAMH=MH.MAMH
AND TENMH=N'TOÁN RỜI RẠC'

--CÂU 18
SELECT TENMH
FROM MONHOC MH, KHOA K
WHERE K.MAKHOA=MH.MAKHOA
EXCEPT
SELECT TENMH
FROM MONHOC MH, KHOA K, HOCPHAN HP
WHERE MH.MAMH=HP.MAMH AND K.MAKHOA=MH.MAKHOA
AND HOCKY=1 AND NAMHOC=1996

--CÂU 19
SELECT MASV, TEN
FROM SINHVIEN SV JOIN KHOA K ON SV.MAKHOA=K.MAKHOA
WHERE NAM=3 AND TENKHOA=N'TOÁN'
EXCEPT
SELECT SV.MASV, TEN
FROM SINHVIEN SV, KHOA K, KETQUA KQ, HOCPHAN HP, MONHOC MH
WHERE SV.MAKHOA=K.MAKHOA AND SV.MASV=KQ.MASV AND HP.MAHP=KQ.MAHP AND MH.MAMH=HP.MAMH
AND NAM=3 AND TENKHOA=N'TOÁN' AND HOCKY=1 AND NAMHOC=1996 AND TENMH=N'CƠ SỞ DỮ LIỆU'
GO

--CÂU 20
SELECT SV.MASV, TEN, COUNT(KQ.MAHP) N'Số học phần'
FROM SINHVIEN SV, KETQUA KQ, HOCPHAN HP
WHERE SV.MASV=KQ.MASV AND HP.MAHP=KQ.MAHP
AND HOCKY=1 AND NAMHOC=1996
GROUP BY SV.MASV, TEN
HAVING COUNT(KQ.MAHP)>3
GO